<!doctype html>
<html lang="ko">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Donkas Lab API</title>
  <style>
    body {
      font-family: Arial, Helvetica, sans-serif;
      margin: 16px
    }

    #log {
      white-space: pre-wrap;
      margin-top: 8px
    }

    ul {
      padding-left: 20px
    }

    button {
      margin-right: 8px
    }
  </style>
</head>

<body>
  <h3>Donkas Lab API - Manychat Monitor</h3>
  <p>이 페이지는 <code>/webhook/received_json/webhook_manychat_events.json</code> 를 주기 폴링하여 변경을 감지합니다.</p>
  <div>
    <button id="httpsRequestBtn">httpsRequest</button>
  </div>

  <script>
    // Set fixed app selection for manychat
    window.appSelect = { value: 'webhook_manychat_events.json' };
  </script>

  <!--
  <script src="js/notification.js"></script>
  -->
  <script src="js/polling_json.js"></script>
  <script src="httpsRequest/sender.js"></script>
  <script>
    (async () => {
      // Start polling for manychat webhook events
      if (typeof registerSW === 'function') await registerSW();
      if (typeof ensureNotificationPermission === 'function') await ensureNotificationPermission();
      if (typeof startPolling === 'function') startPolling();
    })();

    // Example usage and button handler
    document.addEventListener('DOMContentLoaded', () => {
      const btn = document.getElementById('httpsRequestBtn');
      if (!btn) return;

      btn.addEventListener('click', async () => {
        btn.disabled = true;

        // Example inputDataSet - customize as needed
        const inputDataSet = {
          requestTo: 'manychat', // This will be used to lookup bearer token from .env
          url: 'https://api.manychat.com/fb/subscriber/setCustomField', // Target API URL
          payload: {
            subscriber_id: 306159212,
            field_id: 13817158,
            field_value: 100
          }
        };

        const result = await sendHttpsRequest(inputDataSet);

        // Handle the response as needed
        if (result.success !== false) {
          console.log('Request successful:', result);
        } else {
          console.error('Request failed:', result.error);
        }

        btn.disabled = false;
      });
    });
  </script>
</body>

</html>